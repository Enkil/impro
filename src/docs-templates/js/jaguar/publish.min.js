var template=require("jsdoc/template"),fs=require("jsdoc/fs"),path=require("jsdoc/path"),taffy=require("taffydb").taffy,handle=require("jsdoc/util/error").handle,helper=require("jsdoc/util/templateHelper"),_=require("underscore"),htmlsafe=helper.htmlsafe,linkto=helper.linkto,resolveAuthorLinks=helper.resolveAuthorLinks,scopeToPunc=helper.scopeToPunc,hasOwnProp=Object.prototype.hasOwnProperty,data,view,outdir=env.opts.destination;function find(a){return helper.find(data,a)}function tutoriallink(a){return helper.toTutorial(a,null,{tag:"em",classname:"disabled",prefix:"Tutorial: "})}function getAncestorLinks(a){return helper.getAncestorLinks(data,a)}function hashToLink(a,c){if(!/^(#.+)/.test(c)){return c}var b=helper.createLink(a);b=b.replace(/(#.+|$)/,c);return'<a href="'+b+'">'+c+"</a>"}function needsSignature(b){var d=false;if(b.kind==="function"||b.kind==="class"){d=true}else{if(b.kind==="typedef"&&b.type&&b.type.names&&b.type.names.length){for(var c=0,a=b.type.names.length;c<a;c++){if(b.type.names[c].toLowerCase()==="function"){d=true;break}}}}return d}function addSignatureParams(a){var b=helper.getSignatureParams(a,"optional");a.signature=(a.signature||"")+"("+b.join(", ")+")"}function addSignatureReturns(b){var a=helper.getSignatureReturns(b);b.signature='<span class="signature">'+(b.signature||"")+"</span>";if(a.length){b.signature+='<span class="glyphicon glyphicon-circle-arrow-right"></span><span class="type-signature returnType">'+(a.length?"{"+a.join("|")+"}":"")+"</span>"}}function addSignatureTypes(b){var a=helper.getSignatureTypes(b);b.signature=(b.signature||"")+'<span class="type-signature">'+(a.length?" :"+a.join("|"):"")+"</span>"}function addAttribs(a){var b=helper.getAttribs(a);if(b.length){a.attribs='<span class="type-signature '+(b[0]==="static"?"static":"")+'">'+htmlsafe(b.length?b.join(","):"")+"</span>"}}function shortenPaths(b,a){var c=new RegExp("\\\\","g");Object.keys(b).forEach(function(d){b[d].shortened=b[d].resolved.replace(a,"").replace(c,"/")});return b}function resolveSourcePath(a){return path.resolve(process.cwd(),a)}function getPathFromDoclet(a){if(!a.meta){return}var b=a.meta.path&&a.meta.path!=="null"?a.meta.path+"/"+a.meta.filename:a.meta.filename;return b}function generate(g,f,c,d){d=d===false?false:true;var b={filename:c,title:g,docs:f};var a=path.join(outdir,c),e=view.render("container.tmpl",b);if(d){e=helper.resolveLinks(e)}fs.writeFileSync(a,e,"utf8")}function generateSourceFiles(a){Object.keys(a).forEach(function(b){var d;var c=helper.getUniqueFilename(a[b].shortened);helper.registerLink(a[b].shortened,c);try{d={kind:"source",code:helper.htmlsafe(fs.readFileSync(a[b].resolved,"utf8"))}}catch(f){handle(f)}generate("Source: "+a[b].shortened,[d],c,false)})}function attachModuleSymbols(a,c){var b={};a.forEach(function(d){b[d.longname]=d});return c.map(function(d){if(b[d.longname]){d.module=b[d.longname];d.module.name=d.module.name.replace("module:",'require("')+'")'}})}function buildNav(a){var b=[];if(a.namespaces.length){_.each(a.namespaces,function(c){b.push({type:"namespace",longname:c.longname,name:c.name,members:find({kind:"member",memberof:c.longname}),methods:find({kind:"function",memberof:c.longname}),typedefs:find({kind:"typedef",memberof:c.longname}),events:find({kind:"event",memberof:c.longname})})})}if(a.classes.length){_.each(a.classes,function(c){b.push({type:"class",longname:c.longname,name:c.name,members:find({kind:"member",memberof:c.longname}),methods:find({kind:"function",memberof:c.longname}),typedefs:find({kind:"typedef",memberof:c.longname}),events:find({kind:"event",memberof:c.longname})})})}return b}exports.publish=function(E,p,k){data=E;var n=env.conf.templates||{};n["default"]=n["default"]||{};var B=p.template;view=new template.Template(B+"/tmpl");var g=helper.getUniqueFilename("index");var v=helper.getUniqueFilename("global");helper.registerLink("global",v);view.layout="layout.tmpl";helper.setTutorials(k);data=helper.prune(data);data.sort("longname, version, since");helper.addEventListeners(data);var d={};var r=[];data().each(function(F){F.attribs="";if(F.examples){F.examples=F.examples.map(function(I){var J,K;if(I.match(/^\s*<caption>([\s\S]+?)<\/caption>(\s*[\n\r])([\s\S]+)$/i)){J=RegExp.$1;K=RegExp.$3}return{caption:J||"",code:K||I}})}if(F.see){F.see.forEach(function(J,I){F.see[I]=hashToLink(F,J)})}var H;var G;if(F.meta){H=getPathFromDoclet(F);G=resolveSourcePath(H);d[H]={resolved:G,shortened:null};r.push(G)}});var o=(find({kind:"package"})||[])[0];if(o&&o.name){outdir=path.join(outdir,o.name,o.version)}fs.mkPath(outdir);var b=path.join(B,"static");var l=fs.ls(b,3);l.forEach(function(G){var F=fs.toDir(G.replace(b,outdir));fs.mkPath(F);fs.copyFileSync(G,F)});var u;var y;var D;if(n["default"].staticFiles){u=n["default"].staticFiles.paths||[];y=new (require("jsdoc/src/filter")).Filter(n["default"].staticFiles);D=new (require("jsdoc/src/scanner")).Scanner();u.forEach(function(G){var F=D.scan([G],10,y);F.forEach(function(J){var H=fs.statSync(G).isDirectory()?G:path.dirname(G);var I=fs.toDir(J.replace(H,outdir));fs.mkPath(I);fs.copyFileSync(J,I)})})}if(r.length){d=shortenPaths(d,path.commonPrefix(r))}data().each(function(F){var G=helper.createLink(F);helper.registerLink(F.longname,G);var H;if(F.meta){H=getPathFromDoclet(F);H=d[H].shortened;if(H){F.meta.filename=H}}});data().each(function(F){var G=helper.longnameToUrl[F.longname];if(G.indexOf("#")>-1){F.id=helper.longnameToUrl[F.longname].split(/#/).pop()}else{F.id=F.name}if(needsSignature(F)){addSignatureParams(F);addSignatureReturns(F);addAttribs(F)}});data().each(function(F){F.ancestors=getAncestorLinks(F);if(F.kind==="member"){addSignatureTypes(F);addAttribs(F)}if(F.kind==="constant"){addSignatureTypes(F);addAttribs(F);F.kind="member"}});var C=helper.getMembers(data);C.tutorials=k.children;view.find=find;view.linkto=linkto;view.resolveAuthorLinks=resolveAuthorLinks;view.tutoriallink=tutoriallink;view.htmlsafe=htmlsafe;view.members=C;view.nav=buildNav(C);attachModuleSymbols(find({kind:["class","function"],longname:{left:"module:"}}),C.modules);if(n["default"].outputSourceFiles){generateSourceFiles(d)}if(C.globals.length){generate("Global",[{kind:"globalobj"}],v)}var h=find({kind:"file"}),t=find({kind:"package"});generate("Index",t.concat([{kind:"mainpage",readme:p.readme,longname:(p.mainpagetitle)?p.mainpagetitle:"Main Page"}]).concat(h),g);var z=taffy(C.classes);var A=taffy(C.modules);var m=taffy(C.namespaces);var c=taffy(C.mixins);var q=taffy(C.externals);for(var x in helper.longnameToUrl){if(hasOwnProp.call(helper.longnameToUrl,x)){var i=helper.find(z,{longname:x});if(i.length){generate("Class: "+i[0].name,i,helper.longnameToUrl[x])}var j=helper.find(A,{longname:x});if(j.length){generate("Module: "+j[0].name,j,helper.longnameToUrl[x])}var f=helper.find(m,{longname:x});if(f.length){generate("Namespace: "+f[0].name,f,helper.longnameToUrl[x])}var e=helper.find(c,{longname:x});if(e.length){generate("Mixin: "+e[0].name,e,helper.longnameToUrl[x])}var s=helper.find(q,{longname:x});if(s.length){generate("External: "+s[0].name,s,helper.longnameToUrl[x])}}}function w(K,J,F){var G={title:K,header:J.title,content:J.parse(),children:J.children};var I=path.join(outdir,F),H=view.render("tutorial.tmpl",G);H=helper.resolveLinks(H);fs.writeFileSync(I,H,"utf8")}function a(F){F.children.forEach(function(G){w("Tutorial: "+G.title,G,helper.tutorialToUrl(G.name));a(G)})}a(k)};